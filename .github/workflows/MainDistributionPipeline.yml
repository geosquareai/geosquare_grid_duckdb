#
# This workflow calls the main distribution pipeline from DuckDB to build, test and (optionally) release the extension
#
name: Main Extension Distribution Pipeline
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' && github.sha || '' }}
  cancel-in-progress: true

jobs:
  duckdb-stable-build:
    name: Build extension binaries
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@main
    with:
      duckdb_version: ${{ github.ref_name }}
      ci_tools_version: main
      extension_name: geosquare

  deploy_pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: duckdb-stable-build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Restructure files for DuckDB repository format
        run: |
          mkdir -p public
          # The artifact names from _extension_distribution.yml look like:
          # geosquare-v1.4.2-extension-linux_amd64
          # Inside them, we expect geosquare.duckdb_extension
          
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          for artifact_dir in artifacts/geosquare-*-extension-*; do
            if [ -d "$artifact_dir" ]; then
              # Extract architecture from the directory name (the part after last '-')
              ARCH=${artifact_dir##*-}
              
              mkdir -p "public/$TAG_NAME/$ARCH"
              # Copy the extension and rename it if needed to match the requested format
              if [ -f "$artifact_dir/geosquare.duckdb_extension" ]; then
                cp "$artifact_dir/geosquare.duckdb_extension" "public/$TAG_NAME/$ARCH/geosquare_grid.duckdb_extension"
                cp "$artifact_dir/geosquare.duckdb_extension" "public/$TAG_NAME/$ARCH/geosquare.duckdb_extension"
              fi
              # Handle WASM distribution
              if [ -f "$artifact_dir/geosquare.duckdb_extension.wasm" ]; then
                cp "$artifact_dir/geosquare.duckdb_extension.wasm" "public/$TAG_NAME/$ARCH/geosquare_grid.duckdb_extension.wasm"
                cp "$artifact_dir/geosquare.duckdb_extension.wasm" "public/$TAG_NAME/$ARCH/geosquare.duckdb_extension.wasm"
              fi
            fi
          done
          
          echo "Generated directory structure:"
          find public

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true # Don't delete old versions
